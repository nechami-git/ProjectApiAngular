<p-toast></p-toast>
<div class="raffle-content-container" dir="rtl">

    <div class="glass-header mb-4">
        
        <div class="header-title animate-fadein">
            <i class="pi pi-trophy text-gold"></i>
            <div>
                <h1>הגרלת המתנות</h1>
                <p>נהל את ההגרלות ובחר זוכים בכל קטגוריה</p>
            </div>
        </div>

        <div class="header-actions">
            
            <span class="p-input-icon-left w-full md:w-auto">
                <i class="pi pi-search"></i>
                <input type="text" pInputText placeholder="חיפוש מתנה..." 
                       [(ngModel)]="myFilter.name" (keyup.enter)="getAll()"
                       class="w-full md:w-20rem border-round-3xl py-2 px-3 surface-100" />
            </span>

            <span class="p-input-icon-left w-full md:w-auto">
                <i class="pi pi-user"></i>
                <input type="text" pInputText placeholder="חיפוש תורם..." 
                       [(ngModel)]="myFilter.donorName" (keyup.enter)="getAll()"
                       class="w-full md:w-20rem border-round-3xl py-2 px-3 surface-100" />
            </span>

            <button pButton icon="pi pi-search" class="p-button-rounded custom-gold-btn" 
                    (click)="getAll()" pTooltip="חפש"></button>

            <button pButton label="דוח Excel" icon="pi pi-file-excel" 
                    class="p-button-rounded p-button-success p-button-outlined font-bold"
                    (click)="generateReport()"></button>
        </div>
    </div>

    <!-- גריד מתנות עם כרטיסי זכוכית -->
    <div class="gifts-grid">
        
        <div *ngFor="let gift of gifts" class="fadein animation-duration-500">
            <div class="gift-card h-full" [class.winner-declared]="!!gift.winnerName">
                
                <!-- שכבת אנימציית הגרלה -->
                <div class="slot-machine-overlay" *ngIf="rafflingGiftId === gift.id" @fadeIn>
                    <i class="pi pi-spin pi-cog text-6xl text-primary mb-3"></i>
                    <span class="text-2xl text-white font-bold">מבצע הגרלה...</span>
                </div>

                <!-- תמונה -->
                <div class="gift-image-wrapper relative surface-100 h-15rem overflow-hidden border-round-top-2xl">
                    <img *ngIf="gift.image" [src]="gift.image" [alt]="gift.name" 
                         class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" 
                         onerror="this.style.display='none'"/>
                    
                    <div *ngIf="!gift.image" class="flex flex-column align-items-center justify-content-center h-full w-full text-500 bg-gray-100">
                         <i class="pi pi-image text-6xl mb-2 opacity-50"></i>

                    </div>

                    <div class="absolute top-0 right-0 m-2">
                        <p-tag [value]="gift.categoryName" severity="warning" [rounded]="true"></p-tag>
                    </div>

                    <div *ngIf="gift.winnerName" class="absolute bottom-0 w-full bg-green-500 text-white text-center py-1 font-bold shadow-2">
                        <i class="pi pi-check-circle mr-1"></i>הוגרל בהצלחה
                    </div>
                </div>

                <!-- תוכן -->
                <div class="flex flex-column p-4 h-full bg-white-alpha-60">
                    <h2 class="text-xl font-bold text-center text-900 mb-3 mt-0">{{gift.name}}</h2>
                    
                    <div class="grid grid-nogutter text-sm mb-4 surface-50 border-round p-3 row-gap-2">
                        <div class="col-6 flex align-items-center gap-2 mb-2">
                            <i class="pi pi-tag text-primary"></i>
                            <span class="font-semibold text-700">תורם:</span>
                            <span class="text-900">{{gift.donorName}}</span>
                        </div>
                        <div class="col-6 flex align-items-center gap-2 mb-2">
                            <i class="pi pi-money-bill text-green-600"></i>
                            <span class="font-semibold text-700">מחיר:</span>
                            <span class="text-900">{{gift.ticketPrice | currency:'ILS'}}</span>
                        </div>
                        <div class="col-12 flex align-items-center gap-2 border-top-1 border-gray-200 pt-2 mt-1">
                            <i class="pi pi-users text-blue-500"></i>
                            <span class="font-semibold text-700">משתתפים בהגרלה:</span>
                            <b class="text-xl text-primary">{{gift.participantsCount || 0}}</b>
                        </div>
                    </div>

                    <!-- איזור הזוכה -->
                    <div class="mt-auto">
                        <div *ngIf="gift.winnerName" class="winner-section bg-green-50 border-round p-3 text-center border-1 border-green-200 mb-2 fadein">
                            <i class="pi pi-trophy text-4xl text-yellow-500 mb-2 block"></i>
                            <span class="block text-green-700 mb-1">הזוכה המאושר/ת:</span>
                            <strong class="text-2xl text-green-900 block">{{gift.winnerName}}</strong>
                        </div>

                        <button pButton 
                            [label]="gift.winnerName ? 'הגרלה חוזרת' : 'בצע הגרלה עכשיו'" 
                            [icon]="gift.winnerName ? 'pi pi-refresh' : 'pi pi-play'"
                            class="w-full custom-gold-btn border-round-3xl py-3 text-lg shadow-4 hover:shadow-6 transition-all transition-duration-300"
                            [class.p-button-outlined]="!!gift.winnerName"
                            [disabled]="(gift.participantsCount === 0 && !gift.winnerName) || rafflingGiftId !== null"
                            (click)="performRaffle(gift.id)">
                        </button>
                        
                        <div *ngIf="gift.participantsCount === 0 && !gift.winnerName" class="text-center text-red-500 text-sm mt-2">
                            <i class="pi pi-exclamation-circle vertical-align-middle"></i> אין משתתפים להגרלה זו
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- מצב ריק -->
    <div *ngIf="gifts.length === 0" class="flex flex-column align-items-center justify-content-center p-6 glass-header mt-4 opacity-80 text-center">
        <i class="pi pi-gift text-6xl text-400 mb-4 block"></i>
        <h2 class="text-2xl text-700 mb-2">לא נמצאו מתנות להגרלה</h2>
        <p class="text-600 m-0">נסה לשנות את סינוני החיפוש או הוסף מתנות למערכת.</p>
    </div>

</div>

